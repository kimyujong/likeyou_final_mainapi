<!DOCTYPE html>
<html>
<head>
    <title>M1 ë„ë¡œ ìœ„í—˜ë„ ì‹œê°í™” í…ŒìŠ¤íŠ¸</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: 'Noto Sans KR', sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        #controls {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            background: white; padding: 15px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 250px;
        }
        .legend-item { display: flex; align-items: center; margin: 5px 0; }
        .color-box { width: 20px; height: 5px; margin-right: 10px; }
        h3 { margin-top: 0; }
    </style>
</head>
<body>

<div id="controls">
    <h3>ğŸš¦ ë„ë¡œ ìœ„í—˜ë„ (M1)</h3>
    <div>
        <label>ì‹œê°„ëŒ€ ì„ íƒ (0~23ì‹œ): </label>
        <input type="number" id="hourInput" value="18" min="0" max="23" style="width: 50px;">
        <button onclick="loadData()">ì¡°íšŒ</button>
    </div>
    <hr>
    <div id="status">ëŒ€ê¸° ì¤‘...</div>
    <hr>
    <h4>ë²”ë¡€</h4>
    <div class="legend-item"><div class="color-box" style="background:#2ecc71;"></div>ì•ˆì „ (ë‚®ìŒ)</div>
    <div class="legend-item"><div class="color-box" style="background:#f1c40f;"></div>ì£¼ì˜ (ì¤‘ê°„)</div>
    <div class="legend-item"><div class="color-box" style="background:#e74c3c;"></div>ìœ„í—˜ (ë†’ìŒ)</div>
    <div class="legend-item"><div class="color-box" style="background:#8b0000;"></div>ì‹¬ê° (ë§¤ìš° ë†’ìŒ)</div>
</div>

<div id="map"></div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    // 1. ì§€ë„ ì´ˆê¸°í™” (ê´‘ì•ˆë¦¬ ì¤‘ì‹¬)
    var map = L.map('map').setView([35.1532, 129.1185], 14);

    // ë°°ê²½ ì§€ë„ (OpenStreetMap)
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> contributors'
    }).addTo(map);

    var geoJsonLayer = null;

    // 2. ë°ì´í„° ë¡œë“œ ë° ì‹œê°í™” í•¨ìˆ˜
    async function loadData() {
        const hour = document.getElementById('hourInput').value;
        const statusDiv = document.getElementById('status');
        
        statusDiv.innerText = `${hour}ì‹œ ë°ì´í„° ë¡œë”© ì¤‘...`;
        
        try {
            // FastAPI ì„œë²„ ì£¼ì†Œ (ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©)
            // ì£¼ì˜: ì‹¤ì œ ì„œë²„ í¬íŠ¸ì— ë§ì¶° ìˆ˜ì • í•„ìš” (ê¸°ë³¸ 8000)
            const response = await fetch(`http://localhost:8000/m1/risk?hour=${hour}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            const roadData = result.data;
            
            statusDiv.innerText = `ë¡œë”© ì™„ë£Œ: ${result.count}ê°œ ë„ë¡œ`;
            
            // ê¸°ì¡´ ë ˆì´ì–´ ì‚­ì œ
            if (geoJsonLayer) {
                map.removeLayer(geoJsonLayer);
            }

            // GeoJSON ë°ì´í„° ë³€í™˜
            const geoJsonFeatures = roadData.map(item => {
                return {
                    "type": "Feature",
                    "properties": {
                        "name": item.name,
                        "risk_score": item.risk_score,
                        "risk_level": item.risk_level
                    },
                    "geometry": item.geometry
                };
            });

            // ì§€ë„ì— ê·¸ë¦¬ê¸°
            geoJsonLayer = L.geoJSON(geoJsonFeatures, {
                style: function(feature) {
                    return {
                        color: getColor(feature.properties.risk_score),
                        weight: 4,
                        opacity: 0.8
                    };
                },
                onEachFeature: function(feature, layer) {
                    layer.bindPopup(`
                        <b>${feature.properties.name || 'ë„ë¡œëª… ì—†ìŒ'}</b><br>
                        ìœ„í—˜ë„: ${feature.properties.risk_score.toFixed(3)}<br>
                        ë“±ê¸‰: ${feature.properties.risk_level}
                    `);
                }
            }).addTo(map);

        } catch (error) {
            console.error(error);
            statusDiv.innerText = "ì—ëŸ¬ ë°œìƒ! (ì½˜ì†” í™•ì¸)";
            statusDiv.style.color = "red";
        }
    }

    // ìœ„í—˜ë„ë³„ ìƒ‰ìƒ
    function getColor(score) {
        if (score > 0.8) return '#8b0000'; // DarkRed
        if (score >= 0.6) return '#e74c3c'; // Red
        if (score >= 0.4) return '#f1c40f'; // Yellow
        return '#2ecc71'; // Green
    }

    // ì´ˆê¸° ë¡œë”©
    // loadData(); 
</script>

</body>
</html>

