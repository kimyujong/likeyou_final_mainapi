# 🏗️ M5 프로젝트 배포 및 실행 구조도

## 1. 🌍 전체 시스템 아키텍처 (AWS EC2)

단일 EC2 인스턴스 내에서 3개의 주요 백엔드 서비스가 독립된 환경(가상환경/JVM)에서 실행되며, Nginx가 리버스 프록시(Reverse Proxy) 역할을 수행합니다.

### 📦 서버 구성 (Directory & Environment)
```
/home/ubuntu/
├── springboot/           # [메인 백엔드]
│   ├── env: Java 17
│   └── port: 8080 (Internal)
│
├── main-api/            # [AI 허브 서버] M5(방문자예측), M2(경로) 등
│   ├── env: Python 3.10 (venv)
│   ├── port: 8000 (Internal)
│   └── modules:
│       └── m5/          # ⭐ 우리가 만든 방문자 예측 모듈
│
└── p2pnet-api/          # [영상 분석 서버] M3(혼잡도)
    ├── env: Python 3.8 (venv) - 구버전 호환성 때문
    └── port: 8001 (Internal)
```

---

## 2. 🚦 네트워크 흐름 (Nginx Routing)

외부 요청(Client)은 오직 **Nginx(80/443)**하고만 통신하며, Nginx가 내부 포트로 트래픽을 분배합니다.

```mermaid
graph LR
    Client(사용자/Web) --> Nginx[Nginx :80]
    
    Nginx -->|/api/v1/*| Spring[SpringBoot :8080]
    Nginx -->|/api/ai/main/*| MainAPI[Main API :8000]
    Nginx -->|/api/ai/p2p/*| P2PNet[P2PNet API :8001]
    
    Spring -.->|내부 통신 (HTTP)| MainAPI
    Spring -.->|내부 통신 (HTTP)| P2PNet
```

*   **외부 접근**: Nginx를 통해서만 가능 (보안 강화).
*   **내부 통신**: SpringBoot가 필요에 따라 AI 서버들(8000, 8001)에 직접 HTTP 요청을 보낼 수도 있음 (Localhost 통신).

---

## 3. 🔄 데이터 처리 흐름 (M5 방문자 예측 예시)

1.  **요청 (Request)**
    *   **User(Admin)** -> (클릭) -> **React**
    *   **React** -> `POST /api/v1/simulation` -> **SpringBoot**
    *   **SpringBoot** -> `POST http://localhost:8000/m5/predict/all` -> **Main API (M5)**

2.  **처리 (Processing)**
    *   **M5 Module**: 
        1.  과거 날씨 패턴 로딩 (Excel)
        2.  현재 모델 로딩 (.keras)
        3.  LSTM 예측 수행 (5개 지역)

3.  **저장 (Storage)**
    *   **M5 Module** -> `INSERT` -> **Supabase (DB)**
    *   테이블: `DAT_Population_Prediction`

4.  **응답 및 조회 (Response)**
    *   **M5** -> "OK" 응답 -> **SpringBoot**
    *   **SpringBoot** -> `SELECT * FROM DAT_Population_Prediction` -> **Supabase**
    *   **SpringBoot** -> 데이터 가공 -> **React** (그래프 출력)

---

## 4. 🛠️ 운영 관리 (Ops)

*   **프로세스 관리**: `pm2` 또는 `systemd`를 사용하여 백그라운드 실행 및 자동 재시작 관리.
*   **로그 관리**: 
    *   Spring: `nohup.out` 또는 별도 로그 파일
    *   Python: `uvicorn` 로그 (pm2 logs)

### 배포 시 주의사항
1.  **Python 버전 분리**: `main-api`는 3.10, `p2pnet-api`는 3.8을 쓰므로 가상환경(`venv`) 진입 시 주의할 것.
2.  **환경 변수(.env)**: 각 폴더(`springboot`, `main-api`, `p2pnet-api`)마다 별도의 `.env` 파일이 존재해야 함.
3.  **리소스 모니터링**: AI 모델들이 동시에 돌 때 CPU/RAM 사용량 체크 필요 (필요시 Swap 메모리 설정).

