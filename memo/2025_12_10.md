# 📅 2025-12-10 변경 사항 요약 (M2, M3 모듈 고도화)

이 문서는 2025년 12월 10일에 진행된 M2(안심 경로) 및 M3(인구 혼잡도) 모듈의 주요 변경 사항과 로직 개선 내용을 정리한 파일입니다.

---

## 1. 🎯 목표 (Goal)
- **현실적인 제약 사항 해결**: 82개 CCTV 전체에 대해 P2PNet(AI 모델)을 동시에 돌리는 것은 불가능하므로, **일부(2~3개)만 실제 분석**하고 나머지는 **시뮬레이션(Dummy) 데이터**로 대체하는 하이브리드 시스템 구축.
- **데이터 완전성 확보**: M2 경로 탐색 시, 데이터가 없는 구간(Null)을 방지하고 82개 전체 구역에 대한 혼잡도를 반영.
- **운영 편의성 증대**: 서버 실행 명령어 하나로 분석과 시뮬레이션이 동시에 돌아가도록 통합.

---

## 2. 🛠️ M2: 안심 경로 탐색 모듈 (데이터 조회 로직 변경)

### 📌 변경 전 (Before)
- **로직**: `DAT_Crowd_Detection` 테이블만 단순 조회 (`limit 100`).
- **문제점**:
  - M3가 분석 중인 2~3개 CCTV 데이터만 가져옴.
  - 나머지 80여 개 CCTV 데이터 누락 → 경로 탐색 시 해당 구역 정보 부재.
  - 로컬 CSV 파일 의존도가 높음.

### ✅ 변경 후 (After) - `m2/loader.py`
- **로직**: **DB 기반 하이브리드 병합 (Merge) 방식** 적용.
  1.  **Base Data**: `COM_CCTV` 테이블에서 82개 전체 CCTV의 ID와 좌표를 먼저 확보.
  2.  **Live Data**: `DAT_Crowd_Detection` 테이블에서 각 CCTV별 **최신(시간 역순 정렬)** 혼잡도 데이터 조회.
  3.  **Merge**: Base Data에 Live Data를 매핑.
      - 데이터가 있는 곳 → 실시간 값 반영.
      - 데이터가 없는 곳 → 기본값(0) 유지 (하지만 M3 더미 생성기에 의해 거의 항상 데이터가 존재하게 됨).
- **효과**: 82개 전체 구역을 커버하는 완벽한 데이터셋으로 경로 안내 품질 향상.

---

## 3. 👥 M3: 인구 혼잡도 분석 모듈 (더미 생성기 추가)

### 📌 신규 기능: 스마트 더미 생성기 (`m3/dummy_generator.py`)
- **목적**: 실제 AI가 돌지 않는 '빈 깡통' CCTV 구역들에 생명력을 불어넣음.
- **동작 원리 (Smart Logic)**:
  1.  **전체 스캔**: `COM_CCTV`의 모든 ID 조회.
  2.  **활성 감지**: 최근 30초 내에 실제 데이터가 들어온 CCTV(리얼 모드) 식별.
  3.  **Target 선정**: `전체 - 활성 = 비활성(Dummy Target)`
  4.  **Data Injection**: 비활성 CCTV들에 대해서만 10초 주기로 가짜 데이터 `INSERT`.
- **생성 패턴**:
  - 90% 확률: 혼잡도 10~40 (원활/보통)
  - 10% 확률: 혼잡도 70~95 (혼잡/위험) → **시각적 반짝임 효과 연출**

### 📌 서버 통합 (`m3/server.py`)
- **변경 내용**: 서버 시작 시(`startup_event`) 더미 생성기를 **백그라운드 데몬 스레드**로 자동 실행.
- **효과**: `python m3/server.py` 실행 시 **[실제 분석 + 시뮬레이션]**이 동시에 시작됨. 관리 포인트 단일화.

---

## 4. 📊 데이터베이스 테이블 활용 (최종)

| 테이블명 | 역할 | M2 활용 | M3 활용 |
| :--- | :--- | :--- | :--- |
| **`COM_CCTV`** | CCTV 메타 정보 (ID, 좌표) | 전체 목록 조회 (뼈대) | 전체 목록 조회 (더미 타겟 선정) |
| **`DAT_Crowd_Detection`** | 시계열 혼잡도 로그 | 최신 상태 조회 (살 붙이기) | 실시간 분석 결과 및 더미 데이터 적재 |

---

## 5. 🚀 시연 시나리오 (예시)
1.  **Start**: `python m3/server.py` 실행.
2.  **자동 동작**: 더미 생성기가 82개 CCTV 전체에 대해 데이터를 채우기 시작함 (대시보드가 꽉 참).
3.  **리얼 모드 진입**: 관리자가 "CCTV-01" 분석 시작 버튼 클릭 (`/control/start`).
4.  **스마트 전환**:
    - 더미 생성기가 "어? CCTV-01에서 진짜 데이터가 들어오네?" 감지.
    - CCTV-01에 대한 더미 생성 중단 (간섭 방지).
    - 나머지 81개는 계속 더미 유지.
5.  **결과**: 사용자는 어떤 CCTV를 켜든 끄든, 항상 전체 구역이 모니터링되는 듯한 화면을 보게 됨.

